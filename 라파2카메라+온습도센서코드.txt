#!/usr/bin/env python3
# raspberry_unified.py
# ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 - ì¹´ë©”ë¼ + DHT11 ì„¼ì„œ í†µí•© í´ë¼ì´ì–¸íŠ¸
# IP: 192.168.0.99
# 2025-01-13 - Bamgohsi

import cv2
import time
import board
import adafruit_dht
import requests
import threading
from queue import Queue, Empty
from datetime import datetime
import sys
import traceback

# ===== ì„¤ì • =====
CAMERA_SERVER_URL = "http://192.168.0.87:8000/upload_frame_2"
SENSOR_SERVER_URL = "http://192.168.0.87:8000/api/environment"
DHT_PIN = board.D2
CAMERA_WIDTH = 640
CAMERA_HEIGHT = 480
CAMERA_FPS = 30
JPEG_QUALITY = 80
DHT_READ_INTERVAL = 10
STATS_INTERVAL = 10

class RaspberryPi2Unified:
    """ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 í†µí•© í´ë¼ì´ì–¸íŠ¸ (ì¹´ë©”ë¼ + DHT11)"""
    
    def __init__(self):
        print("\n" + "=" * 70)
        print("ğŸ¯ ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 í†µí•© í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”")
        print("=" * 70)
        
        self.cap = None
        self.frame_queue = Queue(maxsize=2)
        self.frame_count = 0
        
        self.dht_device = None
        self.init_dht_sensor()
        
        self.current_temp = None
        self.current_humi = None
        self.sensor_lock = threading.Lock()
        self.last_sensor_read = None
        
        self.total_sent = 0
        self.total_failed = 0
        self.last_stats_time = time.time()
        self.sensor_read_count = 0
        self.sensor_fail_count = 0
        self.sensor_sent_count = 0
        
        print("=" * 70)
    
    def init_dht_sensor(self):
        """DHT11 ì„¼ì„œ ì´ˆê¸°í™”"""
        try:
            self.dht_device = adafruit_dht.DHT11(DHT_PIN)
            print("âœ… DHT11 ì„¼ì„œ ì´ˆê¸°í™” ì™„ë£Œ (GPIO 2)")
        except Exception as e:
            print(f"âš ï¸ DHT11 ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            print("   â†’ ì¹´ë©”ë¼ë§Œ ì‘ë™í•©ë‹ˆë‹¤")
            self.dht_device = None
    
    def setup_camera(self):
        """ì¹´ë©”ë¼ ì„¤ì •"""
        print("\n[ì¹´ë©”ë¼] ì´ˆê¸°í™” ì¤‘...")
        
        cap = cv2.VideoCapture(0, cv2.CAP_V4L2)
        
        if not cap.isOpened():
            print("âŒ ì¹´ë©”ë¼ ì—´ê¸° ì‹¤íŒ¨")
            return None
        
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, CAMERA_WIDTH)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, CAMERA_HEIGHT)
        cap.set(cv2.CAP_PROP_FPS, CAMERA_FPS)
        cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
        
        actual_w = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
        actual_h = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
        actual_fps = cap.get(cv2.CAP_PROP_FPS)
        
        print(f"âœ… ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ: {actual_w}x{actual_h} @ {actual_fps:.1f}fps")
        
        return cap
    
    def read_dht_sensor(self):
        """DHT11 ì„¼ì„œ ì½ê¸° + ì„œë²„ ì „ì†¡"""
        if self.dht_device is None:
            print("\n[DHT11] ì„¼ì„œê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤")
            return
        
        print(f"\n[DHT11] ì„¼ì„œ ì½ê¸° ì‹œì‘ ({DHT_READ_INTERVAL}ì´ˆ ê°„ê²©)")
        
        session = requests.Session()
        
        while True:
            try:
                temp = None
                humi = None
                
                for attempt in range(3):
                    try:
                        temperature = self.dht_device.temperature
                        humidity = self.dht_device.humidity
                        
                        if temperature is not None and humidity is not None:
                            if 0 <= temperature <= 50 and 20 <= humidity <= 90:
                                temp = round(temperature, 1)
                                humi = round(humidity, 1)
                                break
                        
                        if attempt < 2:
                            time.sleep(0.5)
                            
                    except RuntimeError as e:
                        if attempt < 2:
                            time.sleep(0.5)
                            continue
                
                if temp is not None and humi is not None:
                    with self.sensor_lock:
                        self.current_temp = temp
                        self.current_humi = humi
                        self.last_sensor_read = datetime.now()
                    
                    self.sensor_read_count += 1
                    print(f"ğŸŒ¡ï¸  ì˜¨ë„: {temp}Â°C | ìŠµë„: {humi}%")
                    
                    try:
                        sensor_data = {
                            "temperature": temp,
                            "humidity": humi,
                            "sensor_id": "DHT11_RPI2",
                            "location": "ë¼ì¦ˆë² ë¦¬íŒŒì´ #2",
                            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                        }
                        
                        response = session.post(
                            SENSOR_SERVER_URL,
                            json=sensor_data,
                            timeout=3
                        )
                        
                        if response.status_code == 200:
                            self.sensor_sent_count += 1
                            print(f"   âœ… ì„¼ì„œ ë°ì´í„° ì „ì†¡ ì„±ê³µ ({self.sensor_sent_count}íšŒ)")
                        else:
                            print(f"   âš ï¸ ì„¼ì„œ ì „ì†¡ ì‹¤íŒ¨: HTTP {response.status_code}")
                            
                    except Exception as e:
                        print(f"   âš ï¸ ì„¼ì„œ ì „ì†¡ ì˜¤ë¥˜: {e}")
                else:
                    self.sensor_fail_count += 1
                    print(f"âš ï¸ DHT11 ì½ê¸° ì‹¤íŒ¨ ({self.sensor_fail_count}íšŒ)")
                
            except Exception as e:
                print(f"âŒ DHT11 ì˜¤ë¥˜: {e}")
                self.sensor_fail_count += 1
            
            time.sleep(DHT_READ_INTERVAL)
    
    def capture_frames(self):
        """í”„ë ˆì„ ìº¡ì²˜"""
        print("\n[ì¹´ë©”ë¼] í”„ë ˆì„ ìº¡ì²˜ ì‹œì‘")
        
        self.cap = self.setup_camera()
        if self.cap is None:
            print("âŒ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨ - ìº¡ì²˜ ìŠ¤ë ˆë“œ ì¢…ë£Œ")
            return
        
        try:
            while True:
                ret, frame = self.cap.read()
                
                if not ret or frame is None:
                    time.sleep(0.01)
                    continue
                
                self.frame_count += 1
                
                ret, buffer = cv2.imencode(
                    '.jpg', 
                    frame,
                    [cv2.IMWRITE_JPEG_QUALITY, JPEG_QUALITY]
                )
                
                if ret:
                    jpeg_data = buffer.tobytes()
                    
                    try:
                        self.frame_queue.put_nowait(jpeg_data)
                    except:
                        try:
                            self.frame_queue.get_nowait()
                            self.frame_queue.put_nowait(jpeg_data)
                        except:
                            pass
                
                time.sleep(1.0 / CAMERA_FPS)
                
        except Exception as e:
            print(f"âŒ í”„ë ˆì„ ìº¡ì²˜ ì˜¤ë¥˜: {e}")
            traceback.print_exc()
        finally:
            if self.cap:
                self.cap.release()
            print("[ì¹´ë©”ë¼] ì¹´ë©”ë¼ í•´ì œ")
    
    def send_data(self):
        """ì¹´ë©”ë¼ í”„ë ˆì„ ì „ì†¡ (ì›ë³¸ ë°©ì‹)"""
        print("\n[ì „ì†¡] ë°ì´í„° ì „ì†¡ ìŠ¤ë ˆë“œ ì‹œì‘")
        
        session = requests.Session()
        session.timeout = 0.5
        
        consecutive_fails = 0
        
        while True:
            try:
                try:
                    frame_data = self.frame_queue.get(timeout=0.2)
                except Empty:
                    time.sleep(0.01)
                    continue
                
                # ===== ì›ë³¸ ì½”ë“œì™€ ë™ì¼ =====
                try:
                    response = session.post(
                        CAMERA_SERVER_URL, 
                        data=frame_data,  # â† í—¤ë” ì—†ì´!
                        timeout=0.5
                    )
                    
                    if response.status_code == 200:
                        self.total_sent += 1
                        consecutive_fails = 0
                    else:
                        self.total_failed += 1
                        consecutive_fails += 1
                        
                except requests.exceptions.RequestException:
                    self.total_failed += 1
                    consecutive_fails += 1
                
                if consecutive_fails >= 10:
                    print(f"\nâš ï¸ ì¹´ë©”ë¼ ì„œë²„ ì—°ê²° ë¶ˆì•ˆì • ({consecutive_fails}íšŒ ì—°ì† ì‹¤íŒ¨)")
                    print(f"   ì„œë²„ ìƒíƒœ í™•ì¸: {CAMERA_SERVER_URL}\n")
                    consecutive_fails = 0
                    
            except Exception as e:
                print(f"âŒ ì „ì†¡ ì˜¤ë¥˜: {e}")
                time.sleep(0.1)
    
    def print_stats(self):
        """í†µê³„ ì¶œë ¥"""
        print(f"\n[í†µê³„] í†µê³„ ì¶œë ¥ ì‹œì‘ ({STATS_INTERVAL}ì´ˆ ê°„ê²©)\n")
        
        while True:
            try:
                time.sleep(STATS_INTERVAL)
                
                current_time = time.time()
                elapsed = current_time - self.last_stats_time
                fps = self.frame_count / elapsed if elapsed > 0 else 0
                
                with self.sensor_lock:
                    temp = self.current_temp
                    humi = self.current_humi
                
                print("\n" + "=" * 70)
                print(f"ğŸ“Š í†µê³„ ({datetime.now().strftime('%H:%M:%S')})")
                print("=" * 70)
                print(f"ğŸ“¹ ì¹´ë©”ë¼: FPS {fps:.1f} | ì „ì†¡ ì„±ê³µ {self.total_sent} | ì‹¤íŒ¨ {self.total_failed}")
                
                if self.dht_device:
                    sensor_info = f"{temp}Â°C / {humi}%" if temp else "N/A"
                    total_reads = self.sensor_read_count + self.sensor_fail_count
                    sensor_success_rate = (self.sensor_read_count / total_reads * 100) if total_reads > 0 else 0
                    print(f"ğŸŒ¡ï¸  DHT11: {sensor_info} | ì½ê¸° {self.sensor_read_count} | ì „ì†¡ {self.sensor_sent_count} | ì‹¤íŒ¨ {self.sensor_fail_count} | ì„±ê³µë¥  {sensor_success_rate:.1f}%")
                else:
                    print(f"ğŸŒ¡ï¸  DHT11: ë¹„í™œì„±í™”")
                
                print("=" * 70 + "\n")
                
                self.frame_count = 0
                self.last_stats_time = current_time
                
            except Exception as e:
                print(f"âš ï¸ í†µê³„ ì¶œë ¥ ì˜¤ë¥˜: {e}")
                time.sleep(5)
    
    def run(self):
        """ë©”ì¸ ì‹¤í–‰"""
        print("\n" + "=" * 70)
        print("ğŸš€ ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 í†µí•© í´ë¼ì´ì–¸íŠ¸ ì‹œì‘")
        print("=" * 70)
        print(f"ğŸ“¹ ì¹´ë©”ë¼: {CAMERA_WIDTH}x{CAMERA_HEIGHT} @ {CAMERA_FPS}fps")
        print(f"   â†’ {CAMERA_SERVER_URL}")
        print(f"ğŸŒ¡ï¸  DHT11: GPIO 2 - {DHT_READ_INTERVAL}ì´ˆ ê°„ê²©")
        print(f"   â†’ {SENSOR_SERVER_URL}")
        print(f"ğŸ“ ì¥ì¹˜: ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 (192.168.0.99)")
        print("=" * 70)
        
        threads = [
            threading.Thread(target=self.read_dht_sensor, daemon=True, name="DHT-Reader"),
            threading.Thread(target=self.capture_frames, daemon=True, name="Camera-Capture"),
            threading.Thread(target=self.send_data, daemon=True, name="Data-Sender"),
            threading.Thread(target=self.print_stats, daemon=True, name="Stats-Printer")
        ]
        
        for t in threads:
            t.start()
            print(f"âœ… ìŠ¤ë ˆë“œ ì‹œì‘: {t.name}")
        
        print("\n" + "=" * 70)
        print("âœ… ëª¨ë“  ì‹œìŠ¤í…œ ì‘ë™ ì¤‘!")
        print("=" * 70)
        print("ì¢…ë£Œ: Ctrl+C")
        print("=" * 70 + "\n")
        
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n\nğŸ›‘ ì‚¬ìš©ì ì¤‘ë‹¨ ì‹ í˜¸ ìˆ˜ì‹ ")
        finally:
            self.cleanup()
    
    def cleanup(self):
        """ì •ë¦¬ ì‘ì—…"""
        print("\n" + "=" * 70)
        print("ğŸ§¹ ì •ë¦¬ ì‘ì—… ì‹œì‘")
        print("=" * 70)
        
        if self.cap:
            try:
                self.cap.release()
                print("âœ… ì¹´ë©”ë¼ í•´ì œ ì™„ë£Œ")
            except:
                pass
        
        if self.dht_device:
            try:
                self.dht_device.exit()
                print("âœ… DHT11 ì„¼ì„œ í•´ì œ ì™„ë£Œ")
            except:
                pass
        
        print("=" * 70)
        print("âœ… ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 ì‹œìŠ¤í…œ ì¢…ë£Œ ì™„ë£Œ")
        print("=" * 70 + "\n")


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print("\n")
    print("â•”" + "â•" * 68 + "â•—")
    print("â•‘" + " " * 15 + "ë¼ì¦ˆë² ë¦¬íŒŒì´ #2 í†µí•© í´ë¼ì´ì–¸íŠ¸" + " " * 20 + "â•‘")
    print("â•‘" + " " * 68 + "â•‘")
    print("â•‘" + " " * 10 + "ğŸ“¹ Camera Streaming + ğŸŒ¡ï¸ DHT11 Sensor" + " " * 15 + "â•‘")
    print("â•‘" + " " * 68 + "â•‘")
    print("â•‘" + " " * 20 + "Developed by Bamgohsi" + " " * 26 + "â•‘")
    print("â•‘" + " " * 23 + "2025-01-13" + " " * 35 + "â•‘")
    print("â•š" + "â•" * 68 + "â•")
    print("\n")
    
    try:
        client = RaspberryPi2Unified()
        client.run()
    except Exception as e:
        print(f"\nâŒ ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()